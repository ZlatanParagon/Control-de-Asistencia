<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro de Asistencia</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }
    input, button {
      padding: 10px;
      margin: 10px 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    #resultado {
      margin-top: 20px;
      padding: 10px;
      background-color: #f8f8f8;
      border-radius: 5px;
      text-align: left;
    }
    .muted { color:#666; font-size: 12px; }
    .error { color: #b00020; }
    .ok    { color: #0b7a0b; }
    .row   { margin: 6px 0; }
  </style>
</head>
<body>
  <h1>üìÖ Registro de Asistencia</h1>
  <p>Ingresa tu nombre para registrar tu asistencia con ubicaci√≥n e IP p√∫blica</p>

  <input type="text" id="nombre" placeholder="Tu nombre completo" required />
  <button id="btn-registrar">üìç Registrar Mi Asistencia</button>

  <div id="resultado"></div>

  <script>
    // --- Utilidad: obtener IP p√∫blica (varios intentos) ---
    async function getPublicIP() {
      // Intento 1: ipify v4
      try {
        const r = await fetch("https://api.ipify.org?format=json", { cache: "no-store" });
        if (r.ok) {
          const { ip } = await r.json();
          if (ip) return ip;
        }
      } catch {}

      // Intento 2: ipify v6/mixto
      try {
        const r2 = await fetch("https://api64.ipify.org?format=json", { cache: "no-store" });
        if (r2.ok) {
          const { ip } = await r2.json();
          if (ip) return ip;
        }
      } catch {}

      // Si todo falla:
      return null;
    }

    // --- Geolocalizaci√≥n (promesa) ---
    function getGeolocation() {
      return new Promise((resolve, reject) => {
        if (!("geolocation" in navigator)) {
          reject({ code: "UNSUPPORTED", message: "Tu navegador no soporta geolocalizaci√≥n" });
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve(pos),
          (err) => reject(err),
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      });
    }

    // --- Enviar datos por FormSubmit ---
    async function enviarDatos({ nombre, fechaHora, lat, lng, ipPublica }) {
      const formData = new FormData();
      formData.append("nombre", nombre);
      formData.append("fechaHora", fechaHora);
      if (typeof lat === "number" && typeof lng === "number") {
        formData.append("ubicacion", `https://maps.google.com/?q=${lat},${lng}`);
        formData.append("coordenadas", `${lat},${lng}`);
      } else {
        formData.append("ubicacion", "No disponible");
        formData.append("coordenadas", "No disponible");
      }
      formData.append("ip_publica", ipPublica || "No disponible");
      formData.append("user_agent", navigator.userAgent);
      formData.append("timezone", Intl.DateTimeFormat().resolvedOptions().timeZone || "N/D");

      // (Opcional) Asunto del correo y redirecci√≥n:
      formData.append("_subject", "Nuevo registro de asistencia");
      formData.append("_template", "table"); // FormSubmit: ver en formato tabla

      const resp = await fetch("https://formsubmit.co/ajax/sbalderas@arseg.com.mx", {
        method: "POST",
        body: formData,
      });
      // No necesitamos manejar la respuesta para mostrar al usuario;
      // pero por si acaso:
      try {
        const data = await resp.json();
        console.log("FormSubmit:", data);
      } catch (e) {
        console.log("FormSubmit OK (sin JSON legible).");
      }
    }

    async function registrarAsistencia() {
      const nombre = document.getElementById("nombre").value.trim();
      const resultado = document.getElementById("resultado");

      if (!nombre) {
        alert("Por favor ingresa tu nombre");
        return;
      }

      const fechaHora = new Date().toLocaleString();
      resultado.innerHTML = "<p class='muted'>Obteniendo IP y ubicaci√≥n... ‚åõ</p>";

      // Disparamos ambas cosas en paralelo
      const ipPromise = getPublicIP();
      const geoPromise = getGeolocation().catch(err => err); // capturamos error para no romper

      // Esperamos a que ambas terminen (bien o mal)
      const [ipRes, geoRes] = await Promise.allSettled([ipPromise, geoPromise]);

      const ipPublica = ipRes.status === "fulfilled" ? ipRes.value : null;

      let lat = null, lng = null, geoOk = false, geoMsg = "";
      if (geoRes.status === "fulfilled" && geoRes.value && geoRes.value.coords) {
        geoOk = true;
        lat = geoRes.value.coords.latitude;
        lng = geoRes.value.coords.longitude;
      } else {
        // Normalizamos mensajes de error
        const err = geoRes.status === "rejected" ? geoRes.reason : geoRes.value;
        if (err && typeof err === "object" && "code" in err) {
          switch (err.code) {
            case err.PERMISSION_DENIED:
              geoMsg = "Debes permitir el acceso a la ubicaci√≥n para registrar asistencia completa.";
              break;
            case err.POSITION_UNAVAILABLE:
              geoMsg = "La informaci√≥n de ubicaci√≥n no est√° disponible.";
              break;
            case err.TIMEOUT:
              geoMsg = "Tiempo de espera agotado al obtener la ubicaci√≥n.";
              break;
            default:
              geoMsg = "Ocurri√≥ un error al obtener la ubicaci√≥n.";
              break;
          }
        } else if (err && err.code === "UNSUPPORTED") {
          geoMsg = "Tu navegador no soporta geolocalizaci√≥n.";
        } else {
          geoMsg = "No se pudo obtener la ubicaci√≥n.";
        }
      }

      // Armamos la salida al usuario
      let html = `
        <h3 class="ok">‚úÖ Asistencia registrada</h3>
        <div class="row"><strong>Nombre:</strong> ${nombre}</div>
        <div class="row"><strong>Fecha/Hora:</strong> ${fechaHora}</div>
        <div class="row"><strong>IP p√∫blica:</strong> ${ipPublica ? ipPublica : "No disponible"}</div>
      `;

      if (geoOk) {
        const mapaUrl = \`https://maps.google.com/?q=\${lat},\${lng}\`;
        html += `
          <div class="row"><strong>Ubicaci√≥n:</strong> <a href="${"${"}mapaUrl${"}"}" target="_blank" rel="noopener">Ver en mapa</a></div>
          <div class="row">Coordenadas: ${"${"}lat.toFixed(6)${"}"}, ${"${"}lng.toFixed(6)${"}"}</div>
        `;
      } else {
        html += `<div class="row error"><strong>Ubicaci√≥n:</strong> ${geoMsg}</div>`;
      }

      html += `<div class="muted">Navegador: ${"${"}navigator.userAgent${"}"}</div>`;
      resultado.innerHTML = html;

      // Enviamos por email (aunque la geolocalizaci√≥n haya fallado, mandamos lo que tengamos)
      try {
        await enviarDatos({ nombre, fechaHora, lat, lng, ipPublica });
      } catch (e) {
        console.error("Error enviando datos:", e);
      }
    }

    // Bot√≥n
    document.getElementById("btn-registrar").addEventListener("click", registrarAsistencia);
  </script>
</body>
</html>
