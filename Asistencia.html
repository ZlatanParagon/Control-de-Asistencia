<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro de Asistencia</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 640px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }
    h1 { display:flex; align-items:center; gap:.5rem; justify-content:center; }
    input, button {
      padding: 10px;
      margin: 10px 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { background-color: #45a049; }
    #resultado {
      margin-top: 20px;
      padding: 16px;
      background-color: #f8f8f8;
      border-radius: 8px;
      text-align: left;
    }
    .muted { color:#555; font-size: 13px; }
    .error { color: #b00020; }
    .ok    { color: #0b7a0b; }
    .row   { margin: 6px 0; }
    .k { font-weight:600; }
  </style>
</head>
<body>
  <h1>üìÖ Registro de Asistencia</h1>
  <p>Por favor ingresa tu nombre para registrar tu asistencia con ubicaci√≥n e IP p√∫blica.</p>

  <input type="text" id="nombre" placeholder="Tu nombre completo" required />
  <button id="btn-registrar">üìç Registrar Mi Asistencia</button>

  <div id="resultado"></div>

  <script>
    // ---------- Utilidades ----------
    // Timeout helper
    function withTimeout(promise, ms = 8000) {
      return Promise.race([
        promise,
        new Promise((_, rej) => setTimeout(() => rej(new Error("timeout")), ms))
      ]);
    }

    // Obtiene IP p√∫blica probando varias fuentes (por si alguna est√° bloqueada)
    async function getPublicIP() {
      // 1) ipify (v4)
      try {
        const r = await withTimeout(fetch("https://api.ipify.org?format=json", { cache: "no-store" }));
        if (r.ok) {
          const { ip } = await r.json();
          if (ip) return { ip };
        }
      } catch {}

      // 2) ipify (v6/mixto)
      try {
        const r = await withTimeout(fetch("https://api64.ipify.org?format=json", { cache: "no-store" }));
        if (r.ok) {
          const { ip } = await r.json();
          if (ip) return { ip };
        }
      } catch {}

      // 3) ipapi.co (da ip + ciudad/pa√≠s/ISP sin token, con l√≠mites)
      try {
        const r = await withTimeout(fetch("https://ipapi.co/json/", { cache: "no-store" }));
        if (r.ok) {
          const j = await r.json();
          if (j && j.ip) {
            return {
              ip: j.ip,
              city: j.city, region: j.region, country: j.country_name,
              org: j.org || j.org_name || j.asn
            };
          }
        }
      } catch {}

      // 4) Cloudflare trace (texto plano)
      try {
        const r = await withTimeout(fetch("https://www.cloudflare.com/cdn-cgi/trace", { cache: "no-store" }));
        if (r.ok) {
          const text = await r.text();
          const m = text.match(/^ip=(.+)$/m);
          if (m) return { ip: m[1].trim() };
        }
      } catch {}

      // 5) icanhazip (texto)
      try {
        const r = await withTimeout(fetch("https://icanhazip.com", { cache: "no-store" }));
        if (r.ok) {
          const ip = (await r.text()).trim();
          if (ip) return { ip };
        }
      } catch {}

      return null; // sin IP
    }

    function getGeolocation() {
      return new Promise((resolve, reject) => {
        if (!("geolocation" in navigator)) {
          reject({ code: "UNSUPPORTED", message: "Tu navegador no soporta geolocalizaci√≥n" });
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve(pos),
          (err) => reject(err),
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      });
    }

    async function enviarDatos({ nombre, fechaHora, lat, lng, ipInfo }) {
      const formData = new FormData();
      formData.append("nombre", nombre);
      formData.append("fechaHora", fechaHora);
      if (typeof lat === "number" && typeof lng === "number") {
        formData.append("ubicacion", `https://maps.google.com/?q=${lat},${lng}`);
        formData.append("coordenadas", `${lat},${lng}`);
      } else {
        formData.append("ubicacion", "No disponible");
        formData.append("coordenadas", "No disponible");
      }
      formData.append("ip_publica", (ipInfo && ipInfo.ip) ? ipInfo.ip : "No disponible");
      if (ipInfo && (ipInfo.city || ipInfo.region || ipInfo.country)) {
        formData.append("ip_detalle", `${ipInfo.city || ""} ${ipInfo.region || ""} ${ipInfo.country || ""}`.trim());
      }
      if (ipInfo && ipInfo.org) formData.append("ip_org", ipInfo.org);
      formData.append("user_agent", navigator.userAgent);
      formData.append("timezone", Intl.DateTimeFormat().resolvedOptions().timeZone || "N/D");
      formData.append("_subject", "Nuevo registro de asistencia");
      formData.append("_template", "table");

      await fetch("https://formsubmit.co/ajax/sbalderas@arseg.com.mx", {
        method: "POST",
        body: formData
      });
    }

    async function registrarAsistencia() {
      const nombre = document.getElementById("nombre").value.trim();
      const resultado = document.getElementById("resultado");
      if (!nombre) { alert("Por favor ingresa tu nombre"); return; }

      const fechaHora = new Date().toLocaleString();
      resultado.innerHTML = "<p class='muted'>Obteniendo IP y ubicaci√≥n... ‚åõ</p>";

      // Ejecutar en paralelo
      const [ipRes, geoRes] = await Promise.allSettled([ getPublicIP(), getGeolocation() ]);

      const ipInfo = ipRes.status === "fulfilled" ? ipRes.value : null;

      let lat = null, lng = null, geoOk = false, geoMsg = "";
      if (geoRes.status === "fulfilled" && geoRes.value && geoRes.value.coords) {
        geoOk = true;
        lat = geoRes.value.coords.latitude;
        lng = geoRes.value.coords.longitude;
      } else {
        const err = geoRes.status === "rejected" ? geoRes.reason : geoRes.value;
        if (err && typeof err === "object" && "code" in err) {
          switch (err.code) {
            case err.PERMISSION_DENIED:   geoMsg = "Debes permitir el acceso a la ubicaci√≥n para registrar asistencia completa."; break;
            case err.POSITION_UNAVAILABLE: geoMsg = "La informaci√≥n de ubicaci√≥n no est√° disponible."; break;
            case err.TIMEOUT:              geoMsg = "Tiempo de espera agotado al obtener la ubicaci√≥n."; break;
            default:                       geoMsg = "Ocurri√≥ un error al obtener la ubicaci√≥n."; break;
          }
        } else if (err && err.code === "UNSUPPORTED") {
          geoMsg = "Tu navegador no soporta geolocalizaci√≥n.";
        } else {
          geoMsg = "No se pudo obtener la ubicaci√≥n.";
        }
      }

      // Mostrar al usuario
      let html = `
        <h3 class="ok">‚úÖ Asistencia registrada</h3>
        <div class="row"><span class="k">Nombre:</span> ${nombre}</div>
        <div class="row"><span class="k">Fecha/Hora:</span> ${fechaHora}</div>
        <div class="row"><span class="k">IP p√∫blica:</span> ${ipInfo && ipInfo.ip ? ipInfo.ip : "No disponible"}</div>
      `;
      if (ipInfo && (ipInfo.city || ipInfo.region || ipInfo.country)) {
        html += `<div class="row"><span class="k">IP (detalle):</span> ${[ipInfo.city, ipInfo.region, ipInfo.country].filter(Boolean).join(", ")}</div>`;
      }
      if (ipInfo && ipInfo.org) {
        html += `<div class="row"><span class="k">Proveedor/Org:</span> ${ipInfo.org}</div>`;
      }

      if (geoOk) {
        const mapaUrl = `https://maps.google.com/?q=${lat},${lng}`;
        html += `
          <div class="row"><span class="k">Ubicaci√≥n:</span> <a href="${mapaUrl}" target="_blank" rel="noopener">Ver en mapa</a></div>
          <div class="row">Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
        `;
      } else {
        html += `<div class="row error"><span class="k">Ubicaci√≥n:</span> ${geoMsg}</div>`;
      }

      html += `<div class="muted">Navegador: ${navigator.userAgent}</div>`;
      resultado.innerHTML = html;

      // Enviar por email (si falla, no rompe la interfaz)
      try {
        await enviarDatos({ nombre, fechaHora, lat, lng, ipInfo });
      } catch (e) {
        console.error("Error enviando datos:", e);
      }
    }

    document.getElementById("btn-registrar").addEventListener("click", registrarAsistencia);
  </script>
</body>
</html>
